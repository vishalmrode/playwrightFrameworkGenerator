'use strict';

var undici = require('undici');
var config = require('../config.js');
var logger = require('../logger.js');
var getUserAgent = require('../session/getUserAgent.js');

async function queryGraphQL(name, query, variables = {}, apiKey) {
  const userAgent = await getUserAgent.getUserAgent();
  const options = {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "User-Agent": userAgent
    },
    body: JSON.stringify({
      query,
      name,
      variables
    })
  };
  if (apiKey) {
    options.headers.Authorization = `Bearer ${apiKey.trim()}`;
  }
  logger.logDebug("Querying graphql endpoint", { name, replayApiServer: config.replayApiServer });
  const result = await undici.fetch(`${config.replayApiServer}/v1/graphql`, options);
  const json = await result.json();
  logger.logDebug("GraphQL Response", { json });
  return json;
}

exports.queryGraphQL = queryGraphQL;
