'use strict';

var logger = require('../../logger.js');
var source = require('./legacy/source.js');
var index = require('./legacy/test/index.js');

async function sanitizeMetadata(metadata, opts = {}) {
  const updated = {};
  for (const [key, value] of Object.entries(metadata)) {
    if (typeof value !== "object") {
      if (opts.verbose) {
        console.log(
          `Ignoring metadata key "${key}". Expected an object but received ${typeof value}`
        );
      }
      logger.logInfo("SanitizeMetadata:UnexpectedKeyType", { key, keyType: typeof value });
      continue;
    }
    if (value === null || key.startsWith("x-")) {
      updated[key] = value;
    } else {
      switch (key) {
        case "source": {
          try {
            const validated = await source.validate(value);
            Object.assign(updated, validated);
          } catch (error) {
            logger.logDebug("Source validation failed", { error });
          }
          break;
        }
        case "test": {
          try {
            const validated = await index.validate(value);
            Object.assign(updated, validated);
          } catch (error) {
            logger.logDebug("Test validation failed", { error });
          }
          break;
        }
        default: {
          if (opts.verbose) {
            console.log(
              `Ignoring metadata key "${key}". Custom metadata blocks must be prefixed by "x-". Try "x-${key}" instead.`
            );
          }
          logger.logInfo("SanitizeMetadata:IgnoringKey", { key });
        }
      }
    }
  }
  return updated;
}

exports.sanitizeMetadata = sanitizeMetadata;
